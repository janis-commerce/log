'use strict';

const assert = require('assert');

const sandbox = require('sinon').createSandbox();

const AWS = require('aws-sdk');

const S3 = new AWS.S3();

const putObjectStub = sandbox.stub();

sandbox.stub(AWS, 'S3').returns({
	putObject: putObjectStub
});

const Log = require('./../index');

const LogError = require('./../lib/log-error');

const fakeLog = {
	type: 1,
	entity: 'api',
	entity_id: 'product',
	message: '[GET] Request from 0.0.0.0 a product/custom_data',
	date_created: 1559103066,
	user_created: 0,
	log: {
		uri: {
			controller: 'product',
			action: 'custom_data',
			data: []
		},
		responseHttpCode: 200,
		responseTime: '0.3236'
	},
	id: 'a1d2asd1-1a23-a23d-as1d-0asdas2130'
};

const expectedParams = {
	Bucket: 'someBucket',
	Key: 'logs/2019/05/29/a1d2asd1-1a23-a23d-as1d-0asdas2130.json',
	Body: JSON.stringify({ ...fakeLog, service: 'some-service' }),
	ContentType: 'application/json'
};

const setEnvVars = () => {
	process.env.JANIS_SERVICE_NAME = 'some-service';
};

const clearEnvVars = () => {
	delete process.env.JANIS_SERVICE_NAME;
};

describe('Log', () => {

	beforeEach(() => {
		setEnvVars();
		putObjectStub.returns({
			promise: () => {}
		});
	});

	afterEach(() => {
		clearEnvVars();
		sandbox.reset();
	});

	after(() => {
		sandbox.restore();
	});

	describe('_validateLog', () => {

		['log', ['array']].forEach(log => {

			it('should throw when the log is not an object or is an array', () => {

				assert.throws(() => Log._validateLog(log), {
					name: 'LogError',
					code: LogError.codes.INVALID_LOG
				});
			});
		});

		context('when the received log doesn\'t have the required fields', () => {

		});
	});

	it('should call S3.putObject when try to put a log into S3', async () => {

		await Log.add('someBucket', fakeLog);

		sandbox.assert.calledWithExactly(putObjectStub, expectedParams);
		sandbox.assert.calledOnce(putObjectStub);
	});

	it('should generate the log id and date_created when recieves a log without them', async () => {

		const newFakeLog = { ...fakeLog };
		delete newFakeLog.id;
		delete newFakeLog.date_created;

		await Log.add('someBucket', newFakeLog);

		const createdLog = JSON.parse(putObjectStub.lastCall.args[0].Body);

		assert(createdLog.id && createdLog.date_created);

		sandbox.assert.calledOnce(putObjectStub);
	});
});
